
#!/bin/bash
# Copyright 2024 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Iterate 800 feature branch

# for each feature branch

# OPTIONAL: User add some tests (simple, general ones, such as linter, or compiler)
# Run gemini-script-1 to improve api and mapper
# Run gemini-script-2 to add fuzz test
# Run fuzz test to verify api and mapper
# Pass create PR, fail record result in file

# Run gemini-script-3 to improve controller
# Run gemini-script-4 to generate test data
# Run real-gcp test to verify controller
# Pass update PR, fail record result in file

# Run gemini-script-5 to create mockgcp
# Run mock-gcp test to verify mock
# Pass update PR, and assign Yuwen to review.

#!/bin/bash
set -e
set -x

REPO_ROOT="$(git rev-parse --show-toplevel)"
CB_DIR=dev/tools/controllerbuilder

# TODO: remove once the code is merged
UNCOMMIT_ROOT="/usr/local/google/home/yuwenma/go/src/github.com/GoogleCloudPlatform/k8s-config-connector"

INS_CREATE_CRUD_TEST=cmd/codebot/examples/mockgcp-test-case/1-create-test.md
# INS_RECORD_REAL_LOG=cmd/codebot/examples/mockgcp-test-case/2-record-realgcp-output.md
INS_CREATE_MOCK_SERVER=cmd/codebot/examples/mockgcp-test-case/3a-implement-mock.md
INS_COMPARE_MOCK_AND_REAL=cmd/codebot/examples/mockgcp-test-case/3b-compare-mock-output.md

PASS_LOG="${REPO_ROOT}/llm_mock_worker-pass.log" 
FAIL_LOG="${REPO_ROOT}/llm_mock_worker-failure.log"
LLM_LOG="${REPO_ROOT}/llm_mock_worker-llm.log"

FEATURE_BRANCH_PREFIX="mock-llm-"
BRANCH=$(git branch --show)

# This script should be run under the mock feature branch.
# Verify the git repo right resource
if [[ "$BRANCH" != ${FEATURE_BRANCH_PREFIX}* ]]; then
    echo "[ERROR] git HEAD is not in a feature branch"
    exit 1
fi 

RESOURCE=${BRANCH#"${FEATURE_BRANCH_PREFIX}"}
echo "LLM to add mock test for resource ${RESOURCE}" 


retries=1

function codebot() {
    instruction_path=${REPO_ROOT}/${CB_DIR}/$1
    if [[ -d "$instruction_path" ]]; then
        original_path=${UNCOMMIT_ROOT}/${CB_DIR}/$1
        cp "${original_path}" "${instruction_path}"
    fi

    instruction_message=$(cat "$instruction_path")

    output=$(go run "${REPO_ROOT}"/dev/tools/controllerbuilder/cmd/codebot --ui-type="bash" --instruction "${instruction_message}" 2>&1)
    echo "[llm codebot] $(basename "$instruction_path"): ${output}" >> "${LLM_LOG}"
    if [[ $? -ne 0 ]]; then
        echo "[llm codebot] failed on $(basename "$instruction_path")" >> "${FAIL_LOG}"
        exit 1
    fi
    return 0
}

function record_real_log() {
    test_file_name=$(git show --pretty="format:" --name-only HEAD | tail -1)
    if [[ $? -ne 0 ]]; then
        echo "[go test] fail to get crud name: ${test_file_name}" >> "${FAIL_LOG}"
        exit 1
    fi 
    
    test_crud_path=$(dirname "${test_file_name}")
    result=$(WRITE_GOLDEN_OUTPUT=1 E2E_GCP_TARGET=real go test "${REPO_ROOT}"/mockgcp/mockgcptests -run TestScripts/"${test_crud_path}")
    if [[ $? -ne 0 ]]; then
        echo "[go test] fail to run test: ${result}" >> "${FAIL_LOG}"
        exit 1
    fi 
    # TODO check if test failed
    echo "${result}"
    return 0
}

function push_pr() {
    return 0
}


function run_worker() {

    for ((i=retries; i>0; i--)); do

        # Verify mock server
        if ! codebot ${INS_COMPARE_MOCK_AND_REAL}
        then
            echo "[llm codebot] Verified" >> "${PASS_LOG}"
            return 0
        fi

        # Step 1. Use LLM to create test example in testdata/<resource>/crud/script.yaml
        if codebot ${INS_CREATE_CRUD_TEST}
        then
            continue
        fi
        echo "[llm codebot] $(basename $INS_CREATE_CRUD_TEST)" >> "${PASS_LOG}"

        # Step 2. Record real GCP log
        # This can be also be done by codebot. 
        # codebot ${INS_RECORD_REAL_LOG}
        if record_real_log
        then
            continue
        fi
        echo "[go test] record_real_log" >> "${PASS_LOG}"

        # Step 3. Use LLM to create mock server
        if codebot ${INS_CREATE_MOCK_SERVER}
        then
            continue
        fi
        echo "[llm codebot] $(basename $INS_CREATE_MOCK_SERVER)" >> "${PASS_LOG}"

    done

    return 1
}

# Call LLM codebot to generate mock code
if ! run_worker
then
    push_pr
else 
    echo "Unfortunately, this run failed with ${retries} attempts." 
    exit 1
fi
